#!/bin/bash

set -euo pipefail

# Usage:
#   setWallpaper [--sound|--mute] <file>
#   setWallpaper --stop
#
# Examples:
#   setWallpaper ~/Pictures/wall.png
#   setWallpaper --mute ~/Videos/live.webm
#   setWallpaper --sound ~/Videos/live.mp4
#   setWallpaper --stop

sound="mute"
file=""
stop=false

# where to remember the last static wallpaper
STATE_FILE="${XDG_CACHE_HOME:-$HOME/.cache}/setWallpaper_last_image"

# fallback if no last image is known (optional)
DEFAULT_WALLPAPER="$HOME/Pictures/wall.png"

# For Video-Thumbnail
THUMB_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/setWallpaper_thumbs"
mkdir -p "$THUMB_DIR"

# ---- args ----
while [[ $# -gt 0 ]]; do
  case "$1" in
  --sound)
    sound="sound"
    shift
    ;;
  --mute)
    sound="mute"
    shift
    ;;
  --stop)
    stop=true
    shift
    ;;
  -h | --help)
    echo "Usage: setWallpaper [--sound|--mute|--stop] <file>"
    exit 0
    ;;
  *)
    file="$1"
    shift
    ;;
  esac
done

# ---- helpers ----
is_video() {
  local f="${1,,}"
  case "$f" in
  *.mp4 | *.mkv | *.webm | *.mov | *.avi | *.m4v) return 0 ;;
  *) return 1 ;;
  esac
}

video_thumb() {
  local vid="$1"
  # stable name for each file (even if same filename in different directories)
  local key
  key="$(printf '%s' "$vid" | sha256sum | awk '{print $1}')"
  local out="$THUMB_DIR/$key.jpg"

  # only create if not exists or video is new
  if [[ ! -f "$out" || "$vid" -nt "$out" ]]; then
    if command -v ffmpegthumbnailer >/dev/null 2>&1; then
      ffmpegthumbnailer -i "$vid" -o "$out" -s 512 -q 8 >/dev/null 2>&1 || return 1
    elif command -v ffmpeg >/dev/null 2>&1; then
      # Get frame in first second
      ffmpeg -hide_banner -loglevel error -y -ss 1 -i "$vid" -frames:v 1 -vf "scale=512:-1" "$out" || return 1
    else
      return 1
    fi
  fi

  printf '%s' "$out"
}

is_image() {
  local f="${1,,}"
  case "$f" in
  *.png | *.jpg | *.jpeg | *.webp | *.bmp | *.tiff | *.gif) return 0 ;;
  *) return 1 ;;
  esac
}

pretty_name() {
  local p="$1"
  local n
  n="$(basename -- "$p")"
  printf '%s' "$n"
}

restore_last_image() {
  local img=""

  if [[ -f "$STATE_FILE" ]]; then
    img="$(<"$STATE_FILE")"
  fi

  # If cache empty or file missing -> fallback to default
  if [[ -z "${img:-}" || ! -f "$img" ]]; then
    if [[ -f "$DEFAULT_WALLPAPER" ]]; then
      img="$DEFAULT_WALLPAPER"
    else
      return 1
    fi
  fi

  name="$(pretty_name "$img")"

  swww img "$img" --transition-fps 60 --transition-type top
  notify-send -a transient -i "$img" "Live Wallpaper stopped" "Restored: "$name""
  return 0
}

# ---- stop mode ----
if $stop; then
  # stop old live wallpaper if running
  pkill -x mpvpaper 2>/dev/null || true

  if ! restore_last_image; then
    notify-send -a transient "Live Wallpaper stopped" "No static wallpaper found to restore"
  fi
  exit 0
fi

# ---- validate file for normal mode ----
[[ -n "${file:-}" ]] || {
  echo "Missing <file>. Try: setWallpaper --help"
  exit 1
}
[[ -f "$file" ]] || {
  echo "File not found: $file"
  exit 1
}

# stop old live wallpaper if running (switching modes)
pkill -x mpvpaper 2>/dev/null || true

if is_video "$file"; then
  thumb=""
  # get all monitor names (Hyprland)

  echo "Check monitors"
  mapfile -t outputs < <(hyprctl monitors -j | jq -r '.[].name')

  if [[ "${#outputs[@]}" -eq 0 ]]; then
    echo "No monitors found via hyprctl."
    exit 2
  fi

  for mon in "${outputs[@]}"; do
    echo "$mon"
  done

  # pick the monitor that should output the sound
  # - focused monitor if available
  # - otherwise first monitor
  sound_out=""
  echo "Check what monitor should have sound!"
  if [[ "$sound" == "sound" ]]; then
    sound_out="$(hyprctl monitors -j | jq -r '.[] | select(.focused==true) | .name' | head -n1)"
    [[ -n "$sound_out" ]] || sound_out="${outputs[0]}"
  fi

  echo "$sound_out" "has Sound!"
  echo "Applying Live Wallpapers"

  for out in "${outputs[@]}"; do
    if [[ "$sound" == "sound" && "$out" == "$sound_out" ]]; then
      echo "$out"
      mpvpaper -o "loop-file=inf" "$out" "$file" >/dev/null 2>&1 &
      echo "Now has sound!"
    else
      echo "$out"
      mpvpaper -o "loop-file=inf --no-audio" "$out" "$file" >/dev/null 2>&1 &
      echo "Has no sound!"
    fi
  done

  echo "DONE!"

  name="$(pretty_name "$file")"

  thumb="$(video_thumb "$file" 2>/dev/null || true)"

  if [[ -n "$thumb" && -f "$thumb" ]]; then
    notify-send -a transient -i "$thumb" "Live Wallpaper changed" "$name (${sound})"
  else
    notify-send -a transient "Live Wallpaper changed" "$name (${sound})"
  fi

  exit 0
fi

if is_image "$file"; then
  name="$(pretty_name "$file")"
  last=""
  [[ -f "$STATE_FILE" ]] && last="$(<"$STATE_FILE")"

  if [[ "$file" == "$last" ]]; then
    notify-send -a transient -i "$file" "No Change" "Same Wallpaper: $name"
    exit 0
  fi

  swww img "$file" --transition-fps 60 --transition-type top
  mkdir -p "$(dirname "$STATE_FILE")"
  printf '%s' "$file" >"$STATE_FILE"
  notify-send -a transient -i "$file" "Wallpaper changed" "$name"
  exit 0
fi

echo "Unknown file type: $file"
exit 3
