#!/bin/bash

SONGMETA="$HOME/.config/bin/songmeta"
COVER="$HOME/.config/bin/songcover"

PLAYER="spotify"
last_track=""

# Only follow Spotify metadata updates
playerctl -p "$PLAYER" --follow metadata --format '{{artist}}|||{{title}}' 2>/dev/null \
| while IFS='|||' read -r artist title; do
    [[ -z "$artist" && -z "$title" ]] && continue

    track="$artist - $title"
    [[ "$track" == "$last_track" ]] && continue
    last_track="$track"

    artist="$("$SONGMETA" artist "$PLAYER")"
    title="$("$SONGMETA" title "$PLAYER")"
    album="$("$SONGMETA" album "$PLAYER")"
    cover_path="$("$COVER" "$PLAYER")"

    body="$artist"
    [[ -n "$album" ]] && body="$body"$'\n'"$album"

    if [[ -n "$cover_path" && -f "$cover_path" ]]; then
        notify-send -a "Spotify" -i "$cover_path" "$title" "$body"
    else
        notify-send -a "Spotify" "$title" "$body"
    fi
done
